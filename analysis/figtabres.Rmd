---
title: "figs_tabs_results"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Possible palettes #1: #538797, #C2D9CD, #FF842A https://www.instagram.com/p/B9En6h2gbJ5/
#Possible palette #2: #238189, #3FA8B3, #E8F3EE, #FF674D https://www.instagram.com/p/BxZZu82gBm3/


#File structure
rootdir <- rprojroot::find_root(rprojroot::has_dir("src")) 
srcdir <- file.path(rootdir, 'src', 'globalIRmap')
datdir <- file.path(rootdir, 'data')

#Source packages functions
library(drake)
source(file.path(srcdir, 'R/IRmapping_packages.R'))
source(file.path(srcdir, 'R/IRmapping_functions.R'))
source(file.path(srcdir, 'R/IRmapping_plan.R'))

#Get packages
library("rnaturalearth")
library("rnaturalearthdata")
library(rgeos)
library(rgdal)
library(cowplot)
library(maps)
library(patchwork)

#Define paths
riveratlas_path <- file.path(datdir, 'HydroATLAS', 
                             'RiverATLAS_v10.gdb', 'RiverATLAS_v10') 

#Source analysis outputs
loadd(predvars)
loadd(filestructure)
loadd(gaugestats_format)

#Define Winkel Tripel projection
crs_wintri = "+proj=wintri +datum=WGS84 +no_defs +over"

#Get mapping
wcountries <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")
wland <- rnaturalearth::ne_download(scale = 110, type = 'land', category = 'physical')
wlakes <- rnaturalearth::ne_download(scale = 110, type = 'lakes', category = 'physical')

sfformat_wintri <- function(in_sp) {
  return(st_as_sf(in_sp) %>%
           st_transform("+proj=wintri", use_gdal = FALSE)
)
}

#Create winkel tripel graticule
grat_wintri <- 
  st_graticule(lat = c(-89.9, seq(-80, 80, 20), 89.9)) %>%
  st_transform(crs = crs_wintri)

#---- Import and format river network, keeping a subset of columns and only for river orders > 4 --------
cols_tokeep <-  c("HYRIV_ID", "ORD_STRA","dis_m3_pyr")

#predvars[!is.na(ID),varcode],
# 'ele_mt_cav','ele_mt_uav',
# paste0('pre_mm_c', str_pad(1:12, width=2, side='left', pad=0)),
# paste0('cmi_ix_c', str_pad(1:12, width=2, side='left', pad=0)),
# paste0('swc_pc_c', str_pad(1:12, width=2, side='left', pad=0)))

riveratlas_query <- "SELECT HYRIV_ID, ORD_STRA, dis_m3_pyr FROM \"RiverATLAS_v10\" WHERE ORD_STRA > 4"

riveratlas <- st_read(dsn = dirname(riveratlas_path), 
                      layer = basename(riveratlas_path),
                      query = riveratlas_query)

riv_wintri <- sfformat_wintri(riveratlas)
riv_simple <-  sf::st_simplify(riv_wintri, preserveTopology = TRUE, dTolerance = 1000)

#---- Import and format streamgauges --------
gaugepred <- st_read(filestructure['out_gauge']) %>%
  sfformat_wintri


```


```{r basic map}
ggrivers <- function() {
    ggplot() +
    geom_sf(data = grat_wintri, color = alpha("black", 1/10), size = 0.25/.pt) + 
    geom_sf(data=sfformat_wintri(wland), alpha=1/2, color=NA) +
    geom_sf(data=sfformat_wintri(wlakes),  alpha=1/3, fill='black', color=NA) +
    geom_sf(data=riv_simple[riv_simple$ORD_STRA < 6,][1:20000,], 
            aes(size=ORD_STRA), color=alpha('black', 1/30), show.legend = F) +
    geom_sf(data=riv_simple[riv_simple$ORD_STRA >= 6,][1:20000,], 
            aes(size=ORD_STRA), color=alpha('black', 1/15), show.legend = F) +
    scale_size_continuous(range=c(0.5, 1.2)) +
    coord_sf(datum = NA, ylim=c(-7000000,8700000), expand=F) +
    theme_map()
}

perennial_gauges <- gaugepred[gaugepred$intermittent=='0',]
p_pr <- ggrivers() + 
  geom_sf(data=perennial_gauges, aes(color=totalYears_kept), size=1, alpha=1/2) +
  scale_color_gradient(low='#0F9FD6', high='#152540', 
                       breaks=c(min(perennial_gauges$totalYears_kept), 100, max(perennial_gauges$totalYears_kept))) +
  coord_sf(datum = NA, ylim=c(-7000000,8700000), expand=F) 

ir_gauges <-  gaugepred[gaugepred$intermittent=='1',]
p_ir <- ggrivers() + 
  geom_sf(data=ir_gauges, aes(color=totalYears_kept), size=1, alpha=1/2) +
  scale_color_gradient(low='#ff9b52', high='#a32d18', 
                       breaks=c(min(ir_gauges$totalYears_kept), 100, max(ir_gauges$totalYears_kept))) +
  coord_sf(datum = NA, ylim=c(-7000000,8700000), expand=F)

p_pr/p_ir

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
