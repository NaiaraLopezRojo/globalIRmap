---
title: "figs_tabs_results"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = TRUE,
	warning = TRUE
)
```


```{r setup, include=FALSE}
#Possible palettes #1: #538797, #C2D9CD, #FF842A https://www.instagram.com/p/B9En6h2gbJ5/
#Possible palette #2: #238189, #3FA8B3, #E8F3EE, #FF674D https://www.instagram.com/p/BxZZu82gBm3/


#File structure
rootdir <- rprojroot::find_root(rprojroot::has_dir("src")) 
srcdir <- file.path(rootdir, 'src', 'globalIRmap')
datdir <- file.path(rootdir, 'data')
resdir <- file.path(rootdir, 'results')

#Source packages functions
library(drake)
source(file.path(srcdir, 'R/IRmapping_packages.R'))
source(file.path(srcdir, 'R/IRmapping_functions.R'))
source(file.path(srcdir, 'R/IRmapping_plan.R'))

#Load targets 
loadd(filestructure)
```


#Main text - Figure 1. Geographical distribution of reference streamgauging stations
```{r basic map, echo = FALSE, fig.width = 6,  dpi=300}
loadd(gauges_plot)
print(gauges_plot)

```

#Methods - Table 1. Environmental variables used in model training  + variable selection results
```{r variable figure, echo=FALSE } 
loadd(table_predvars)
table_predvars
```

#Methods - Figure 1. Environmental distribution of reference streamgauging stations
Bernhard, is dor_pc_pva x 100 rather than x10 (as written in doc)?
```{r envdistrib, fig.width = 12, fig.height=8, dpi=300, message=FALSE}
loadd(envhist)
plot(envhist)
```


#Methods - Table 2. Specification and benchmark comparison of models
```{r models benchmarking table, echo=FALSE}
loadd(tablebm_classif1)
loadd(tablebm_regr1)
loadd(tablebm_classif2)
setup_table <- rbindlist(list(tablebm_classif1$setup, 
                              tablebm_regr1$setup,
                              tablebm_classif2$setup),
                         fill=T, use.names=T)

kable(setup_table)

results_table <- rbindlist(list(tablebm_classif1$results, 
                              tablebm_regr1$results,
                              tablebm_classif2$results),
                         fill=T, use.names=T)

kable(results_table)
```

#Methods - Figure 2. Benchmark comparison of models through curves
```{r models benchmarking curves, echo=FALSE}
loadd(misclass_plot)
print(misclass_plot)

```

#Main text - Figure 2. Variable importance for top 15 variables
```{r variable importance, fig.width=12, echo=FALSE}
loadd(vimp_plot)
vimp_plot
```

#Main text - Figure 3. Partial dependence plots
```{r partial dependence, fig.width=12, fig.height=12, echo=FALSE}
loadd(pd_plot)
lapply(pd_plot, function(p) plot(p))
```

#Methods - Figure 3 A. Predictions uncertainty by metavariable and environment
```{r prediction uncertainty by variable, fig.width=12, fig.height=10}
loadd( uncertainty_plot)
uncertainty_plot
```


#Tables of intermittence by categories
```{r setup, echo=FALSE}

loadd(gaugestats_format)
get_tabletarget <- function(in_gaugeformat) {
  lapply(names(in_gaugeformat), function(var) {
    targetname <- paste0('globaltables_', var) 
    #print(targetname)
    tryCatch(return(readd(eval(targetname), character_only = T) %>%
                      setDT(tab) %>%
                      setorder(-Total)),
             error=function(e) NULL)
  })
}

tables <- get_tabletarget(gaugestats_format) %>%
  compact

lapply(tables, function(x)  print(kable(x, digits=0)))
```
