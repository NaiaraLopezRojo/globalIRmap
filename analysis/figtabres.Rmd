---
title: "figs_tabs_results"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Possible palettes #1: #538797, #C2D9CD, #FF842A https://www.instagram.com/p/B9En6h2gbJ5/
#Possible palette #2: #238189, #3FA8B3, #E8F3EE, #FF674D https://www.instagram.com/p/BxZZu82gBm3/


#File structure
rootdir <- rprojroot::find_root(rprojroot::has_dir("src")) 
srcdir <- file.path(rootdir, 'src', 'globalIRmap')
datdir <- file.path(rootdir, 'data')

#Source packages functions
library(drake)
source(file.path(srcdir, 'R/IRmapping_packages.R'))
source(file.path(srcdir, 'R/IRmapping_functions.R'))
source(file.path(srcdir, 'R/IRmapping_plan.R'))

#Get packages
library("rnaturalearth")
library("rnaturalearthdata")
library(rgeos)
library(rgdal)
library(cowplot)
library(maps)
library(patchwork)
#remotes::install_github("zeehio/facetscales")
library(facetscales)
library(scales)

#Define paths
riveratlas_path <- file.path(datdir, 'HydroATLAS', 
                             'RiverATLAS_v10.gdb', 'RiverATLAS_v10') 

#Source analysis outputs
loadd(predvars)
loadd(filestructure)
loadd(gaugestats_format)

#Define Winkel Tripel projection
crs_wintri = "+proj=wintri +datum=WGS84 +no_defs +over"

#Get mapping
wcountries <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")
wland <- rnaturalearth::ne_download(scale = 110, type = 'land', category = 'physical')
wlakes <- rnaturalearth::ne_download(scale = 110, type = 'lakes', category = 'physical')

sfformat_wintri <- function(in_sp) {
  return(st_as_sf(in_sp) %>%
           st_transform("+proj=wintri", use_gdal = FALSE)
)
}

#Create winkel tripel graticule
grat_wintri <- 
  st_graticule(lat = c(-89.9, seq(-80, 80, 20), 89.9)) %>%
  st_transform(crs = crs_wintri)

#---- Import and format river network lines, keeping a subset of columns and only for river orders > 4 --------
riv_query <- "SELECT HYRIV_ID, ORD_STRA, dis_m3_pyr FROM \"RiverATLAS_v10\" WHERE ORD_STRA > 4"
riv_lines <- st_read(dsn = dirname(riveratlas_path), 
                      layer = basename(riveratlas_path),
                      query = riv_query)

riv_wintri <- sfformat_wintri(riv_lines)
riv_simple <-  sf::st_simplify(riv_wintri, preserveTopology = TRUE, dTolerance = 1000)

#---- Import and format streamgauges --------
gaugepred <- st_read(filestructure['out_gauge']) %>%
  sfformat_wintri

#---- Import and format river network attributes ------------------------------
cols_tokeep <-  c("HYRIV_ID", predvars[!is.na(ID),varcode],
                  'ele_mt_cav','ele_mt_uav',
                  paste0('pre_mm_c', str_pad(1:12, width=2, side='left', pad=0)),
                  paste0('cmi_ix_c', str_pad(1:12, width=2, side='left', pad=0)),
                  paste0('swc_pc_c', str_pad(1:12, width=2, side='left', pad=0)))

riveratlas <- fread_cols(filestructure['in_riveratlas'], 
                         cols_tokeep = cols_tokeep) %>%
  comp_derivedvar


```

#Geographical distribution of reference gauging stations
```{r basic map, echo = FALSE, fig.width = 6,  dpi=300}
ggrivers <- function() {
    ggplot() +
    geom_sf(data = grat_wintri, color = alpha("black", 1/10), size = 0.25/.pt) + 
    geom_sf(data=sfformat_wintri(wland), alpha=1/2, color=NA) +
    geom_sf(data=sfformat_wintri(wlakes),  alpha=1/3, fill='black', color=NA) +
    geom_sf(data=riv_simple[riv_simple$ORD_STRA < 6,][1:20000,], 
            aes(size=ORD_STRA), color=alpha('black', 1/30), show.legend = F) +
    geom_sf(data=riv_simple[riv_simple$ORD_STRA >= 6,][1:20000,], 
            aes(size=ORD_STRA), color=alpha('black', 1/15), show.legend = F) +
    scale_size_continuous(range=c(0.5, 1.2)) +
    coord_sf(datum = NA, ylim=c(-7000000,8700000), expand=F) +
    theme_map()
}

perennial_gauges <- gaugepred[gaugepred$intermittent=='0',]
p_pr <- ggrivers() + 
  geom_sf(data=perennial_gauges, aes(color=totalYears_kept), size=1, alpha=1/2) +
  scale_color_gradient(name='Years of data', low='#0F9FD6', high='#152540', 
                       breaks=c(min(perennial_gauges$totalYears_kept), 100, max(perennial_gauges$totalYears_kept))) +
  coord_sf(datum = NA, ylim=c(-7000000,8700000), expand=F) 

ir_gauges <-  gaugepred[gaugepred$intermittent=='1',]
p_ir <- ggrivers() + 
  geom_sf(data=ir_gauges, aes(color=totalYears_kept), size=1, alpha=1/2) +
  scale_color_gradient(name='Years of data', low='#ff9b52', high='#a32d18', 
                       breaks=c(min(ir_gauges$totalYears_kept), 100, max(ir_gauges$totalYears_kept))) +
  coord_sf(datum = NA, ylim=c(-7000000,8700000), expand=F)

p_pr/p_ir

```

#Environmental distribution of reference gauging stations
Bernhard, is dor_pc_pva x 100 rather than x10?

```{r pressure, fig.width = 10, fig.height=6, dpi=300, message=FALSE}
#Radar plot of selected variables
#names(riveratlas)

varstoplot_hist <- c("ari_ix_uav", "cly_pc_uav", "clz_cl_cmj", "cmi_ix_uyr", "dis_m3_pmn", "dis_m3_pyr", "dor_pc_pva",
                     "for_pc_use", "gla_pc_use", "gwt_cm_cav", "inu_pc_umn", "ire_pc_use", "kar_pc_use", "lka_pc_use",
                     "pet_mm_uyr", "snw_pc_uyr", "run_mm_cyr", "swc_pc_uyr", "tmp_dc_uyr")


formatscales <- function(in_df, varstoplot) {
  scales_x <- list(
    ari_ix_uav = scale_x_continuous(),
    cly_pc_uav = scale_x_continuous(labels=percent_format(scale=1)),
    clz_cl_cmj = scale_x_continuous(limits=c(1,18), expand=c(0,0),
                                    breaks=seq(0,18,2)),
    cmi_ix_uyr = scale_x_continuous(),
    dis_m3_pmn = scale_x_sqrt(breaks=c(0, 10^(0:log10(max(in_df$dis_m3_pmn)))),
                              labels=c(0, 10^(0:log10(max(in_df$dis_m3_pmn))))),
    dis_m3_pyr = scale_x_sqrt(breaks=c(0, 10^(0:log10(max(in_df$dis_m3_pmn)))),
                              labels=c(0, 10^(0:log10(max(in_df$dis_m3_pmn))))),
    dor_pc_pva = scale_x_continuous(labels=percent_format(scale=1)),
    for_pc_use = scale_x_continuous(labels=percent_format(scale=1)),
    gla_pc_use = scale_x_continuous(labels=percent_format(scale=1)),
    gwt_cm_cav = scale_x_continuous(), #Change that to gwt_m_cav
    inu_pc_umn = scale_x_continuous(labels=percent_format(scale=1)),
    ire_pc_use = scale_x_continuous(labels=percent_format(scale=1)),
    kar_pc_use = scale_x_continuous(labels=percent_format(scale=1)),
    lka_pc_use = scale_x_continuous(labels=percent_format(scale=1)),
    pet_mm_uyr = scale_x_continuous(), 
    snw_pc_uyr = scale_x_continuous(labels=percent_format(scale=1)),
    run_mm_cyr = scale_x_continuous(),
    swc_pc_uyr = scale_x_continuous(labels=percent_format(scale=1)),
    tmp_dc_uyr = scale_x_continuous()
  )
  
  scales_y <- unlist(rep(list(scale_y_log10(expand=c(0,0))), labels = scientific_format(),
                         length(scales_x)), 
                     recursive=F) %>%
    setNames(names(scales_x))
  scales_y[['dis_m3_pmn']] <- scale_y_sqrt(expand=c(0,0))
  
  coordcart <- lapply(varstoplot_hist, function(var) {
    coord_cartesian(xlim=as.data.table(in_df)[, c(min(get(var)), max(get(var)))])
  }) %>%
    setNames(names(scales_x))
  coordcart[['clz_cl_cmj']] <-  coord_cartesian(
    xlim=c(1,max(in_df$clz_cl_cmj)))
  
  
  return(list(scales_x=scales_x, scales_y=scales_y, coordcart=coordcart))
}

scalesenvhist <- formatscales(riveratlas, varstoplot)


ggenvhist <- function(vartoplot, in_gaugedt, in_rivdt, in_predvars, intermittent=TRUE) {
  print(vartoplot)
  if (intermittent) {
    vartoplot2 <- c(vartoplot, 'intermittent')
  }
  
  varname <- in_predvars[varcode==vartoplot, paste0(Attribute, ' ', 
                                                    Keyscale, 
                                                    Keystat, 
                                                    ' (',unit,')')]
  
  gaugeformat <- as.data.table(in_gaugedt)[, vartoplot2, with=F] 
  rivformat <- as.data.table(in_rivdt)[, vartoplot, with=F]
  
  
  penvhist <- ggplot(gaugeformat, aes_string(x=vartoplot)) +
    geom_histogram(data=rivformat, bins=20, fill='lightgray') + 
    geom_histogram(bins=20, fill='darkgray') + #aes(fill=intermittent), position = 'stack') - doesn't work with log or sqrt y scale
    scale_fill_manual(values=c('#0F9FD6','#ff9b52'), 
                      labels = c('Perennial', 'Intermittent'), name=NULL) +
    scalesenvhist$scales_x[[vartoplot]] +
    scalesenvhist$scales_y[[vartoplot]] +
    scalesenvhist$coordcart[[vartoplot]] +
    xlab(varname) +
    ylab('Count') +
    theme_classic() + 
    theme(strip.background=element_rect(colour="white", fill='lightgray'),
          axis.title.y = element_blank())


  if (which(vartoplot %in% varstoplot_hist)!=length(varstoplot_hist)) {
    penvhist <- penvhist + 
      theme(legend.position='none')
  }

  return(ggplotGrob(penvhist)) 
}

penvhist_grobs <- lapply(varstoplot_hist, ggenvhist, 
                         in_gaugedt = gaugepred, 
                         in_rivdt = riveratlas,
                         in_predvars=predvars)
do.call("grid.arrange", list(grobs=penvhist_grobs))


# ggplot(mydf) +
#   geom_point(aes(x = Subject, y = Value)) +
#   facet_grid_sc(rows = vars(Magnitude), scales = list(y = scales_y))



#   scale_color_gradient(name='Years of data', low='#0F9FD6', high='#152540', 
#                        breaks=c(min(perennial_gauges$totalYears_kept), 100, max(perennial_gauges$totalYears_kept))) +
#   coord_sf(datum = NA, ylim=c(-7000000,8700000), expand=F) 
# 
# ir_gauges <-  gaugepred[gaugepred$intermittent=='1',]
# p_ir <- ggrivers() + 
#   geom_sf(data=ir_gauges, aes(color=totalYears_kept), size=1, alpha=1/2) +
#   scale_color_gradient(name='Years of data', low='#ff9b52', high='#a32d18', 
#                        breaks=c(min(ir_gauges$totalYears_kept), 100, max(ir_gauges$totalYears_kept))) +
# 
# 
# 
#     geom_vline(data=gagesenvrec, aes(xintercept=WsArea, color=select),alpha=0.75, size=0.75) +
#     geom_histogram(bins=50, fill='#878787', alpha=0.5) + 
#     scale_x_log10(name=expression('Catchment area'~(km^2)),
#                   breaks = c(1,10,100,1000,10000,100000),
#                   labels = c(1,10,expression(10^2),expression(10^3),expression(10^4),expression(10^5)),
#                   expand=c(0,0)) +
#     scale_y_continuous(name='Number of stream reaches', expand=c(0,0)) + 
#     scale_color_manual(values=c(notselRGB,selRGB))+
#     theme_env() + 
#     labs(subtitle = "(a)")

```

