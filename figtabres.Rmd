---
title: "figs_tabs_results"
output: word_document
---

```{r import, echo=FALSE}
#Possible palettes #1: #538797, #C2D9CD, #FF842A https://www.instagram.com/p/B9En6h2gbJ5/
#Possible palette #2: #238189, #3FA8B3, #E8F3EE, #FF674D https://www.instagram.com/p/BxZZu82gBm3/
#File structure
rootdir <- rprojroot::find_root(rprojroot::has_dir("src"))
srcdir <- file.path(rootdir, 'src', 'globalIRmap')
datdir <- file.path(rootdir, 'data')
resdir <- file.path(rootdir, 'results')

#Source packages functions
library(drake)
library(flextable)
source(file.path(srcdir, 'R/IRmapping_packages.R'))
source(file.path(srcdir, 'R/IRmapping_functions.R'))
source(file.path(srcdir, 'R/IRmapping_plan.R'))

loadd(gpredsdt)
```


#Geographical distribution of reference streamgauging stations
##Statistics for paper
- Number of gauges in total: `gpredsdt[, .N]`  
- Number of perennial gauges taking in account only post-1961 (average number of years of data): 
`gpredsdt[intermittent_o1961==0, .N]`(`gpredsdt[intermittent_o1961==0, mean(totalYears_kept_o1961)]`)
- Number of intermittent gauges taking in account only post-1961 (average number of years of data): 
`gpredsdt[intermittent_o1961==1, .N]`(`gpredsdt[intermittent_o1961==1, mean(totalYears_kept_o1961)]`)
gpredsdt[dis_m3_pyr < 10, .SD[intermittent_o1961==0,.N]/.SD[intermittent_o1961==1,.N]]
gpredsdt[dis_m3_pyr >= 10, .SD[intermittent_o1961==0,.N]/.SD[intermittent_o1961==1,.N]]

```{r basic-map, echo = FALSE, fig.width = 6,  dpi=300}
loadd(gauges_plot)
print(gauges_plot)
```

#Environmental variables used in model training  + variable selection results
```{r variabl-figure, echo=FALSE}
loadd(predvars)
flextable(predvars[,c('Category', 'Attribute', 'Spatial representation',
                      'Temporal/Statistical aggreg.', 'Source', 'Citation'),
                   with=F])
```

#Environmental distribution of reference streamgauging stations
Bernhard, is dor_pc_pva x 100 rather than x10 (as written in doc)?
```{r envdistrib, fig.width = 12, fig.height=8, dpi=300, message=FALSE, echo=FALSE}
loadd(envhist)
plot(envhist)
```


#Methods - Table 2. Specification and benchmark comparison of models
```{r models-benchmarking-table, echo=FALSE}
loadd(tablebm_classif1_u10)
loadd(tablebm_regr1_u10)
loadd(tablebm_classif2_u10)
setup_table_u10 <- rbindlist(list(tablebm_classif1_u10$setup,
                              tablebm_regr1_u10$setup,
                              tablebm_classif2_u10$setup),
                         fill=T, use.names=T)

flextable(setup_table_u10)

results_table_u10 <- rbindlist(list(tablebm_classif1_u10$results,
                                tablebm_regr1_u10$results,
                                tablebm_classif2_u10$results),
                           fill=T, use.names=T)
flextable(results_table_u10)

loadd(tablebm_classif1_o1)
loadd(tablebm_regr1_o1)
loadd(tablebm_classif2_o1)
setup_table_o1 <- rbindlist(list(tablebm_classif1_o1$setup,
                              tablebm_regr1_o1$setup,
                              tablebm_classif2_o1$setup),
                         fill=T, use.names=T)

flextable(setup_table_o1)

results_table_o1 <- rbindlist(list(tablebm_classif1_o1$results,
                              tablebm_regr1_o1$results,
                              tablebm_classif2_o1$results),
                         fill=T, use.names=T)
flextable(results_table_o1)
```

#Methods - Figure 2. Benchmark comparison of models through curves
```{r models-benchmarking-curves, fig.width=8, echo=FALSE}
loadd(misclass_plot_u10)
print(misclass_plot_u10)

loadd(misclass_plot_o1)
print(misclass_plot_o1)

```

#Main text - Figure 2. Variable importance for top 15 variables
```{r variable-importance, fig.width=12, fig.height=6, echo=FALSE}
loadd(vimp_plot_u10)
print(vimp_plot_u10)

loadd(vimp_plot_o1)
print(vimp_plot_o1)
```

#Main text - Figure 3. Partial dependence plots
```{r partial-dependence, fig.width=12, fig.height=12, echo=FALSE}
loadd(pd_plot_u10)
lapply(pd_plot_u10, function(p) plot(p))

loadd(pd_plot_o1)
lapply(pd_plot_o1, function(p) plot(p))
```

#Methods - Figure 3 A. Predictions uncertainty by metavariable and environment
```{r prediction-uncertainty-by-variable, fig.width=12, fig.height=10, echo=FALSE}
loadd(gaugeIPR_plot)
print(gaugeIPR_plot_u10["gaugeIPR_numplot"])

loadd(gaugeIPR_plot_o1)
print(gaugeIPR_plot_o1["gaugeIPR_numplot"])
```


#Tables of intermittence by categories
```{r inter-tables, echo=FALSE}
loadd(gaugestats_format)
get_tabletarget <- function(in_gaugeformat) {
  lapply(names(in_gaugeformat), function(var) {
    targetname <- paste0('globaltables_', var)
    #print(targetname)
    tryCatch(return(readd(eval(targetname), character_only = T) %>%
                      setDT(tab) %>%
                      setorder(-`Total stream length (10^3 km)`)),
             error=function(e) NULL)
  })
}

tables <- get_tabletarget(gaugestats_format) %>%
  compact

ft <- list()
for (i in 1:length(tables)) {
  numcols <- names(tables[[i]])[tables[[i]][,sapply(.SD, class)=='numeric']]
  ft[[i]] <- flextable(tables[[i]][, (numcols) := lapply(.SD, function(x) as.integer(x)),
                              .SDcols = numcols]) %>%
    autofit
}
ft[[1]]
ft[[2]]
ft[[3]]
ft[[4]]
```

#Comparison of results with regional-national estimates
```{r comparison, echo = FALSE, fig.width = 8,  dpi=300}
loadd(fr_plot)
print(fr_plot)

loadd(us_plot)
print(us_plot)
```

#Comparison of results with on-the-ground observations
```{r QC, echo = FALSE, fig.width = 8,  dpi=300}
loadd(pnw_plot)
print(pnw_plot)

loadd(onde_plot)
print(onde_plot)
```
